<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ASR Service with Speaker Diarization</title>
    <link rel="stylesheet" href="/static/unified_styles.css" />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <div class="brand">ASR Service with Speaker Diarization</div>
        <div class="subtitle">Upload audio file for transcription with speaker identification.</div>
      </header>

      <section class="card">
        <h2>Get API Token</h2>
        <button id="get-token-btn" class="button" type="button">Generate New Token</button>
        
        <div id="token-result" class="result-section">
          <div class="form-group">
            <label class="label" for="api-token-display">Your API Token (valid for 1 hour):</label>
            <input type="text" id="api-token-display" class="input" readonly>
          </div>
          <button id="copy-token-btn" class="button" type="button">Copy Token</button>
        </div>
        
        <div id="token-error-message" class="statusText err"></div>
      </section>

      <section class="card">
        <h2>Upload Audio File</h2>
        <form id="upload-form">
          <div class="form-group">
            <label class="label" for="audio-file">Select Audio File (WAV, MP3, M4A, AAC, FLAC, OGG, OPUS):</label>
            <input type="file" id="audio-file" class="input" accept=".wav,.mp3,.m4a,.aac,.flac,.ogg,.opus" required>
          </div>
          
          <div class="form-group">
            <label class="label" for="language">Language:</label>
            <select id="language" class="select">
              <option value="zh">Chinese</option>
              <option value="en">English</option>
              <option value="fr">French</option>
              <option value="es">Spanish</option>
              <option value="de">German</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="label" for="api-token">API Token:</label>
            <input type="password" id="api-token" class="input" placeholder="Enter your API token" required>
          </div>
          
          <button type="submit" id="submit-btn" class="button">Transcribe Audio</button>
        </form>
        
        <div id="hint" class="hint">
          Make sure you have generated an API token before uploading.
        </div>
      </section>

      <section class="loading" id="loading">
        <div class="spinner"></div>
        <div>Processing audio... This may take a few minutes.</div>
      </section>

      <section class="status">
        <div id="error-message" class="statusText err"></div>
      </section>

      <section class="result-section" id="result-section">
        <h3>Transcription Results</h3>
        <button id="download-btn" class="button" type="button">Download JSON</button>
        <div id="json-output" class="scrollable-textarea"></div>
      </section>

      <footer class="footer">
        <div>
          Built with FastAPI and advanced ASR technology.
        </div>
      </footer>
    </main>

    <script>
      document.getElementById('upload-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('audio-file');
        const languageSelect = document.getElementById('language');
        const apiTokenInput = document.getElementById('api-token');
        const loadingElement = document.getElementById('loading');
        const errorMessageElement = document.getElementById('error-message');
        const resultSection = document.getElementById('result-section');
        const jsonOutput = document.getElementById('json-output');
        const submitBtn = document.getElementById('submit-btn');
        
        // Reset UI
        errorMessageElement.textContent = '';
        resultSection.style.display = 'none';
        
        // Validate input
        if (!fileInput.files.length) {
          errorMessageElement.textContent = 'Please select an audio file.';
          return;
        }
        
        const file = fileInput.files[0];
        const language = languageSelect.value;
        const apiToken = apiTokenInput.value;
        
        // Check file type
        const lowerName = file.name.toLowerCase();
        if (!lowerName.endsWith('.wav') && !lowerName.endsWith('.mp3') && !lowerName.endsWith('.m4a') && !lowerName.endsWith('.aac') && !lowerName.endsWith('.flac') && !lowerName.endsWith('.ogg') && !lowerName.endsWith('.opus')) {
          errorMessageElement.textContent = 'Please select a WAV, MP3, M4A, AAC, FLAC, OGG, or OPUS file.';
          return;
        }
        
        // Show loading indicator
        loadingElement.style.display = 'block';
        submitBtn.disabled = true;
        
        try {
          // Create FormData
          const formData = new FormData();
          formData.append('file', file);
          formData.append('language', language);
          
          // Send request to ASR service
          const response = await fetch('/transcribe', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${apiToken}`
            },
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          // Display result
          jsonOutput.textContent = JSON.stringify(result, null, 2);
          resultSection.style.display = 'block';
          
          // Set up download button
          document.getElementById('download-btn').onclick = function() {
            const blob = new Blob([JSON.stringify(result, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transcription_result.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };
        } catch (error) {
          console.error('Error:', error);
          errorMessageElement.textContent = `Error processing audio: ${error.message}`;
        } finally {
          // Hide loading indicator
          loadingElement.style.display = 'none';
          submitBtn.disabled = false;
        }
      });
      
      // Token generation functionality
      document.getElementById('get-token-btn').addEventListener('click', async function() {
        const tokenErrorElement = document.getElementById('token-error-message');
        const tokenResultElement = document.getElementById('token-result');
        const tokenDisplayElement = document.getElementById('api-token-display');
        const getTokenBtn = document.getElementById('get-token-btn');
        
        // Reset UI
        tokenErrorElement.textContent = '';
        tokenResultElement.style.display = 'none';
        
        // Show loading state
        getTokenBtn.disabled = true;
        getTokenBtn.textContent = 'Generating...';
        
        try {
          // Request new token from API
          const response = await fetch('/auth/token', {
            method: 'POST'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          
          // Display token
          tokenDisplayElement.value = result.token;
          tokenResultElement.style.display = 'block';
          
          // Set up copy button
          document.getElementById('copy-token-btn').onclick = function() {
            tokenDisplayElement.select();
            document.execCommand('copy');
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => {
              this.textContent = originalText;
            }, 2000);
          };
        } catch (error) {
          console.error('Error:', error);
          tokenErrorElement.textContent = `Error generating token: ${error.message}`;
        } finally {
          // Reset button state
          getTokenBtn.disabled = false;
          getTokenBtn.textContent = 'Generate New Token';
        }
      });
    </script>
  </body>
</html>